<div class="flags-list-container">
  <div class="header">
    <div>
      <mat-form-field>
        <input
          class="search-input"
          matInput
          (keyup)="applyFilter($event.target.value)"
          [placeholder]="'global.search.text' | translate"
        />
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>
    </div>
    <button
      mat-flat-button
      color="primary"
      *ngIf="(permissions$ | async)?.featureFlags.create"
      (click)="openNewFlagDialog()"
    >
      <app-shared-icons class="icon" [iconType]="'plus'"></app-shared-icons>
        {{ 'feature-flags.add-flag.text' | translate }}
    </button>
  </div>

  <div class="flags-list-table-container" #tableContainer>
    <mat-progress-bar class="spinner" mode="indeterminate" *ngIf="isLoadingFeatureFlags$ | async"></mat-progress-bar>
    <table
      class="flags-list"
      mat-table
      [dataSource]="allFeatureFlags"
      matSort
    >
      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>
          <span [matTooltip]="'feature-flags.global-name.text' | translate" matTooltipPosition="above">
            {{ 'feature-flags.global-name.text' | translate | uppercase }}
          </span>
        </th>
        <td mat-cell *matCellDef="let flag">
          <a [routerLink]="['/featureFlags', 'detail', flag.id]" *ngIf="flag.name?.length < 30; else flagNameEllipsis" class="flag-name">
            {{ flag.name }}
          </a>
          <ng-template #flagNameEllipsis>
            <a [routerLink]="['/flag', 'detail', flag.id]" [matTooltip]="flag.name" class="flag-name" matTooltipPosition="above">
              {{ flag.name | truncate: 30 }}
            </a>
          </ng-template>
          <br />
          <span class="flag-description" *ngIf="flag.description?.length < 30; else flagDescription">
            {{ flag.description }}
          </span>
          <ng-template #flagDescription>
            <span class="flag-description" [matTooltip]="flag.description" matTooltipPosition="above">
              {{ flag.description | truncate: 35 }}
            </span>
          </ng-template>
        </td>
      </ng-container>

      <ng-container matColumnDef="key">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>
          <span [matTooltip]="'feature-flags.global-key.text' | translate" matTooltipPosition="above">
            {{ 'feature-flags.global-key.text' | translate | uppercase }}
          </span>
        </th>
        <td
          mat-cell
          *matCellDef="let flag"
        >
          <span>{{ flag.key }}</span>
        </td>
      </ng-container>

      <ng-container matColumnDef="variationType">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>
          <span [matTooltip]="'feature-flags.table-variation-type.text' | translate" matTooltipPosition="above">
            {{ 'feature-flags.table-variation-type.text' | translate | uppercase }}
          </span>
        </th>
        <td mat-cell *matCellDef="let flag">
          <span>{{ flag.variationType | titlecase }}</span>
        </td>
      </ng-container>

      <ng-container matColumnDef="activeVariant">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>
          <span [matTooltip]="'feature-flags.global-active-variation.text' | translate" matTooltipPosition="above">
            {{ 'feature-flags.global-active-variation.text' | translate | uppercase }}
          </span>
        </th>
        <td mat-cell *matCellDef="let flag">
          <span>{{ getActiveVariation(flag) }}</span>
        </td>
      </ng-container>

      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>
          <span [matTooltip]="'feature-flags.global-status.text' | translate" matTooltipPosition="above">
            {{ 'feature-flags.global-status.text' | translate | uppercase }}
          </span>
        </th>
        <td mat-cell *matCellDef="let flag">
          <mat-slide-toggle
            color="primary"
            [checked]="flag.status"
            [disabled]="!(permissions$ | async).featureFlags.update"
            (change)="changeFlagStatus(flag.id, $event)"
          >
          </mat-slide-toggle>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
    </table>
    <mat-paginator class="paginator" [hidePageSize]="true" [pageSize]="5"></mat-paginator>
  </div>
</div>
