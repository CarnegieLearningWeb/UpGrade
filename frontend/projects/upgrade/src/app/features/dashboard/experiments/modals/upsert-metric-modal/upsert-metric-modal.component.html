<app-common-dialog
  [title]="config.title"
  [cancelBtnLabel]="config.cancelBtnLabel"
  [primaryActionBtnLabel]="config.primaryActionBtnLabel"
  [primaryActionBtnColor]="config.primaryActionBtnColor"
  [primaryActionBtnDisabled]="isPrimaryButtonDisabled$ | async"
  (primaryActionBtnClicked)="onPrimaryActionBtnClicked()"
>
  <form [formGroup]="metricForm" class="form-standard dense-3">

    <!-- Metric Type Radio Group -->
    <div class="metric-type-container dense-1">
      <span class="section-label ft-14-600">Metric Type</span>
      <mat-radio-group formControlName="metricType" class="radio-group-vertical">
        <mat-radio-button value="global" class="ft-14-400">
          <span class="radio-label">
            <strong>Global Metric</strong>
            <span class="radio-description">Used for globally accumulated measures (e.g., total time spent using the app).</span>
          </span>
        </mat-radio-button>
        <mat-radio-button value="repeatable" class="ft-14-400">
          <span class="radio-label">
            <strong>Repeatable Metric</strong>
            <span class="radio-description">Used for repeatable measures (e.g., score on a quiz that can be taken multiple times).</span>
          </span>
        </mat-radio-button>
      </mat-radio-group>
    </div>

    <!-- Repeatable Metric Fields -->
    <ng-container *ngIf="showMetricClass">
      <mat-form-field appearance="outline">
        <mat-label class="ft-14-400">Metric Class</mat-label>
        <input
          matInput
          formControlName="metricClass"
          placeholder="e.g., workspace"
          class="ft-14-400"
          [matAutocomplete]="metricClassAutocomplete"
        />
        <mat-autocomplete #metricClassAutocomplete="matAutocomplete" panelWidth="auto" [displayWith]="displayFn">
          <mat-option
            *ngFor="let metricClass of filteredMetricClasses$ | async"
            [value]="metricClass"
            class="ft-14-400"
          >
            {{ metricClass.key }}
          </mat-option>
        </mat-autocomplete>
        <mat-hint class="form-hint ft-12-400">
          The metric class categorizes what type of app component is being measured (e.g., workspace).
        </mat-hint>
      </mat-form-field>
    </ng-container>

    <ng-container *ngIf="showMetricKey">
      <mat-form-field appearance="outline">
        <mat-label class="ft-14-400">Metric Key</mat-label>
        <input
          matInput
          formControlName="metricKey"
          placeholder="e.g., problem ID"
          class="ft-14-400"
          [matAutocomplete]="metricKeyAutocomplete"
        />
        <mat-autocomplete #metricKeyAutocomplete="matAutocomplete" panelWidth="auto" [displayWith]="displayFn">
          <mat-option
            *ngFor="let metricKey of filteredMetricKeys$ | async"
            [value]="metricKey"
            class="ft-14-400"
          >
            {{ metricKey.key }}
          </mat-option>
        </mat-autocomplete>
        <mat-hint class="form-hint ft-12-400">
          The metric key specifies the specific instance of the metric class being measured (e.g., problem ID).
        </mat-hint>
      </mat-form-field>
    </ng-container>

    <!-- Metric ID -->
    <mat-form-field appearance="outline">
      <mat-label class="ft-14-400">Metric ID</mat-label>
      <input
        matInput
        formControlName="metricId"
        placeholder="e.g., completionStatus, totalTimeSeconds"
        class="ft-14-400"
        [matAutocomplete]="metricIdAutocomplete"
      />
      <mat-autocomplete #metricIdAutocomplete="matAutocomplete" panelWidth="auto" [displayWith]="displayFn">
        <mat-option
          *ngFor="let metric of filteredMetricIds$ | async"
          [value]="metric"
          class="ft-14-400"
        >
          {{ metric.key }}
        </mat-option>
      </mat-autocomplete>
      <mat-hint class="form-hint ft-12-400">
        The Metric ID specifies the data type (continuous or categorical) and what data to measure.
      </mat-hint>
    </mat-form-field>

    <!-- Individual Statistic (Repeatable only) -->
    <ng-container *ngIf="showIndividualStatistic && showAggregateStatistic">
      <mat-form-field appearance="outline">
        <mat-label class="ft-14-400">Individual Statistic</mat-label>
        <mat-select formControlName="individualStatistic" class="ft-14-400">
          <mat-option
            *ngFor="let option of individualStatisticOptions"
            [value]="option.value"
            class="ft-14-400"
          >
            {{ option.label }}
          </mat-option>
        </mat-select>
        <mat-hint class="form-hint ft-12-400">
          The Individual Statistic determines which value to use for each student.
          <a class="learn-more-link" href="https://www.upgradeplatform.org/" target="_blank" rel="noopener noreferrer">
            Learn more
          </a>
        </mat-hint>
      </mat-form-field>
    </ng-container>

    <!-- Aggregate Statistic -->
    <ng-container *ngIf="showAggregateStatistic">
      <mat-form-field appearance="outline">
        <mat-label class="ft-14-400">Aggregate Statistic</mat-label>
        <mat-select formControlName="aggregateStatistic" class="ft-14-400">
          <mat-option
            *ngFor="let option of aggregateStatisticOptions"
            [value]="option.value"
            class="ft-14-400"
          >
            {{ option.label }}
          </mat-option>
        </mat-select>
        <mat-hint class="form-hint ft-12-400">
          The Aggregate Statistic determines how to combine values across all students.
          <a class="learn-more-link" href="https://www.upgradeplatform.org/" target="_blank" rel="noopener noreferrer">
            Learn more
          </a>
        </mat-hint>
      </mat-form-field>
    </ng-container>

    <!-- Comparison (Categorical only) -->
    <ng-container *ngIf="showComparison">
      <div class="comparison-container dense-1">
        <span class="section-label ft-14-600">Comparison</span>
        <mat-radio-group formControlName="comparison" class="radio-group-horizontal">
          <mat-radio-button
            *ngFor="let option of comparisonOptions"
            [value]="option.value"
            class="ft-14-400"
          >
            {{ option.label }}
          </mat-radio-button>
        </mat-radio-group>
      </div>
    </ng-container>

    <!-- Value (Categorical only) -->
    <ng-container *ngIf="showComparison && allowableDataKeys.length > 0">
      <mat-form-field appearance="outline">
        <mat-label class="ft-14-400">Value</mat-label>
        <mat-select formControlName="compareValue" class="ft-14-400">
          <mat-option
            *ngFor="let value of allowableDataKeys"
            [value]="value"
            class="ft-14-400"
          >
            {{ value }}
          </mat-option>
        </mat-select>
        <mat-hint class="form-hint ft-12-400">
          The categorical metric data type requires you to specify which allowed value to measure.
        </mat-hint>
      </mat-form-field>
    </ng-container>

    <!-- Display Name -->
    <mat-form-field appearance="outline">
      <mat-label class="ft-14-400">Display Name</mat-label>
      <input
        matInput
        formControlName="displayName"
        placeholder="Enter display name"
        class="ft-14-400"
      />
      <mat-hint class="form-hint ft-12-400">
        The display name is used to refer to this metric in the experiment UI.
      </mat-hint>
    </mat-form-field>

    <!-- Description -->
    <mat-form-field appearance="outline">
      <mat-label class="ft-14-400">Description (optional)</mat-label>
      <textarea
        matInput
        formControlName="description"
        rows="3"
        placeholder="Enter description"
        class="ft-14-400"
      ></textarea>
      <mat-hint class="form-hint ft-12-400">
        Optional description for this metric.
      </mat-hint>
    </mat-form-field>

  </form>
</app-common-dialog>
