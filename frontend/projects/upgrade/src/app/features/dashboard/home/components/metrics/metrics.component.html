<ng-container *ngIf="options[0]?.length" >
  <form class="metric-design" [formGroup]="queryForm">
    <!-- Metric Table -->
    <ng-container>
      <mat-table
        class="metric-table"
        [dataSource]="metricsDataSource"
        formArrayName="queries"
        #metricTable
      >
        <!-- Metric Column -->
        <ng-container matColumnDef="keys">
          <mat-header-cell class="ft-14-700" *matHeaderCellDef>
            {{ 'query.metric.text' | translate }}
          </mat-header-cell>
          <mat-cell
            *matCellDef="let element; let groupIndex = index"
            [formGroupName]="groupIndex"
          >
          <div class="auto-complete-container">
            <ng-container formArrayName="keys">
              <div *ngFor="let key of keys.controls; let formIndex = index">
                <ng-container [formGroupName]="formIndex">
                  <span>
                    <mat-form-field class="auto-complete">
                      <input
                        type="text"
                        matInput
                        formControlName="metricKey"
                        [matAutocomplete]="auto"
                        >
                      <mat-autocomplete 
                        (optionSelected)="selectedOption($event)"
                        #auto="matAutocomplete"
                        [displayWith]="displayFn"
                        panelWidth="fit-content"
                        >
                        <mat-option *ngFor="let option of filteredOptions[formIndex] | async" [value]="option">
                          {{option.key}}
                        </mat-option>
                      </mat-autocomplete>
                    </mat-form-field>
                  </span>
                </ng-container>
              </div>
            </ng-container>
          </div>
          </mat-cell>
        </ng-container>

        <!-- Statistic Column -->
        <ng-container matColumnDef="operationType">
          <mat-header-cell class="ft-14-700" *matHeaderCellDef>
            {{ 'monitor.statistic.text' | translate }}
          </mat-header-cell>
          <mat-cell
            *matCellDef="let element; let groupIndex = index"
            [formGroupName]="groupIndex"
          >
          <div class="secondary-form" *ngIf="selectedNode?.metadata?.type !== IMetricMetadata.CONTINUOUS">
            <mat-form-field class="ft-14-600 form-control">
              <mat-label>{{ 'monitor.statistic.text' | translate | titlecase }}</mat-label>
              <mat-select class="ft-14-400" formControlName="operationType">
                <mat-option
                  *ngFor="let operation of queryOperations"
                  [value]="operation.value"
                >
                  {{ operation.viewValue | titlecase }}
                </mat-option>
              </mat-select>
            </mat-form-field>
            <mat-form-field class="ft-14-600 form-control" *ngIf="selectedNode?.metadata?.type !== IMetricMetadata.CONTINUOUS">
              <mat-label>{{ 'query.form-comparison-function.text' | translate | titlecase }}</mat-label>
              <mat-select class="ft-14-400" formControlName="compareFn">
                <mat-option>{{ 'query.none-option.text' | translate }}</mat-option>
                <mat-option
                  *ngFor="let fn of comparisonFns"
                  [value]="fn.value"
                >
                  {{ fn.viewValue | titlecase }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field class="ft-14-600 form-control" *ngIf="selectedNode?.metadata?.type !== IMetricMetadata.CONTINUOUS">
              <mat-label>{{ 'query.form-compare-value.text' | translate | titlecase }}</mat-label>
              <mat-select class="ft-14-400" formControlName="compareValue">
                <mat-option
                  *ngFor="let value of selectedNode?.allowedData"
                  [value]="value"
                >
                  {{ value | titlecase }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>
          </mat-cell>
        </ng-container>

        <!-- Description Column -->
        <ng-container matColumnDef="queryName">
          <mat-header-cell class="ft-14-700" *matHeaderCellDef>
            {{ 'global.description.text' | translate }}
          </mat-header-cell>
          <mat-cell
            *matCellDef="let element; let groupIndex = index"
            [formGroupName]="groupIndex"
          >
            <mat-form-field floatLabel="never">
              <span>
                <input
                  matInput
                  [placeholder]="
                    'home.new-experiment.metrics.description.placeholder.text'
                      | translate
                  "
                  formControlName="queryName"
                />
              </span>
            </mat-form-field>
          </mat-cell>
        </ng-container>

        <ng-container matColumnDef="removeMetric">
          <mat-header-cell class="ft-14-700" *matHeaderCellDef></mat-header-cell>
          <mat-cell
            *matCellDef="let element; let groupIndex = index"
            [formGroupName]="groupIndex"
          >
            <mat-icon
              class="remove-icon"
              (click)="removeMetric(groupIndex)"
            >
              delete_outline
            </mat-icon>
          </mat-cell>
        </ng-container>

        <mat-header-row
          *matHeaderRowDef="metricsDisplayedColumns; sticky: true"
        ></mat-header-row>
        <mat-row *matRowDef="let row; columns: metricsDisplayedColumns"></mat-row>
      </mat-table>
      
      <button
        type="button"
        class="ft-12-700 add-metric"
        (click)="addKey()"
      >
        +
        {{ 'home.new-experiment.design.add-metric.text' | translate }}
      </button>
    </ng-container>
    <br>
    <br>
    <br>
    <div class="button-container">
      <button
        matStepperPrevious
        mat-raised-button
        class="modal-btn btn-back default-button"
      >
        {{ 'global.back.text' | translate }}
      </button>
      <div>
        <button
          type="button"
          mat-raised-button
          class="modal-btn"
          (click)="emitEvent(NewExperimentDialogEvents.CLOSE_DIALOG)"
        >
          {{ 'global.cancel.text' | translate }}
        </button>
        <button
          type="button"
          mat-raised-button
          class="modal-btn default-button"
          [ngClass]="{ 'default-button--disabled': !this.queryForm.valid }"
          [disabled]="!this.queryForm.valid"
          (click)="saveQuery()"
        >
          <span>{{ 'global.save.text' | translate }}</span>
        </button>
        <button
          type="button"
          mat-raised-button
          class="modal-btn default-button"
          (click)="emitEvent(NewExperimentDialogEvents.SEND_FORM_DATA)"
        >
          {{ 'global.next.text' | translate }}
        </button>
        <button
          type="button"
          *ngIf="experimentInfo"
          mat-raised-button
          class="modal-btn default-button"
          (click)="emitEvent(NewExperimentDialogEvents.SAVE_DATA)"
        >
          {{ 'global.update.text' | translate }}
        </button>
      </div>
    </div>
  </form>
</ng-container>
