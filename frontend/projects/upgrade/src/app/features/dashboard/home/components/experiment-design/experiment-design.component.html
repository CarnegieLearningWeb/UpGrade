<div class="shared-modal--step-container scrollable" #stepContainer>
  <section class="shared-modal--form-container">
    <!--NOTE: this form content may need to be broken out into separate component when factorial design-type introduced-->
    <section class="simple-experiment-form">
      <form class="experiment-design" [formGroup]="experimentDesignForm">
        <section class="simple-experiment-decision-point-conditions-view">
          <div class="decision-point-header-container">
            <span class="title">{{ 'home.new-experiment.design.decision-point.text' | translate }}</span>
            <button
              type="button"
              mat-flat-button
              color="primary"
              class="ft-14-600 default-button toggle-button"
              (click)="scrollToAliasesTable()"
              [class.default-button--disabled]= "(isFormLockedForEdit$ | async) || isAliasTableButtonDisabled"
              [disabled]="(isFormLockedForEdit$ | async) || isAliasTableButtonDisabled"
            >
              <mat-icon class="icon icon-bump-left">expand_more</mat-icon>
              <span class="toggle-text">{{ 'home.new-experiment.design.toggle-actions.aliases' | translate }}</span>
            </button>
          </div>

          <!-- Decision Point Table -->
          <ng-container>
            <mat-table
              class="partition-table"
              [dataSource]="partitionDataSource"
              formArrayName="partitions"
              #partitionTable
            >
              <!-- Site Column -->
              <ng-container matColumnDef="site">
                <mat-header-cell class="ft-14-700" *matHeaderCellDef>
                  {{ 'home.new-experiment.design.partition-point.text' | translate }}
                </mat-header-cell>
                <mat-cell *matCellDef="let element; let groupIndex = index" [formGroupName]="groupIndex">
                  <ng-container *ngIf="(decisionPointsTableEditIndex$ | async) !== groupIndex">
                    <span [matTooltip]="partition.at(groupIndex).get('site').value" matTooltipPosition="above">
                      {{ partition.at(groupIndex).get('site').value | truncate: 35 }}
                    </span>
                  </ng-container>
                  <ng-container *ngIf="(decisionPointsTableEditIndex$ | async) === groupIndex">
                    <mat-form-field floatLabel="never">
                      <span
                        [matTooltip]="experimentDesignForm.getRawValue('site')?.partitions[groupIndex]?.site"
                        matTooltipPosition="above"
                      >
                        <input
                          matInput
                          [placeholder]="'home.new-experiment.design.partition-point.placeholder.text' | translate"
                          formControlName="site"
                          [matAutocomplete]="autoCompleteExperimentPoints"
                        />
                        <mat-autocomplete #autoCompleteExperimentPoints="matAutocomplete" panelWidth="fit-content">
                          <mat-option *ngFor="let site of filteredExpPoints$[groupIndex] | async" [value]="site">
                            {{ site }}
                          </mat-option>
                        </mat-autocomplete>
                      </span>
                    </mat-form-field>
                  </ng-container>
                </mat-cell>
              </ng-container>

              <!-- Target Column -->
              <ng-container matColumnDef="target">
                <mat-header-cell class="ft-14-700" *matHeaderCellDef>
                  {{ 'home.new-experiment.design.partition-id.text' | translate }}
                </mat-header-cell>
                <mat-cell *matCellDef="let element; let groupIndex = index" [formGroupName]="groupIndex">
                  <ng-container *ngIf="(decisionPointsTableEditIndex$ | async) !== groupIndex">
                    <span [matTooltip]="partition.at(groupIndex).get('target').value" matTooltipPosition="above">
                      {{ partition.at(groupIndex).get('target').value | truncate: 35 }}
                    </span>
                  </ng-container>
                  <ng-container *ngIf="(decisionPointsTableEditIndex$ | async) === groupIndex">
                    <mat-form-field floatLabel="never">
                      <span
                        [matTooltip]="experimentDesignForm.getRawValue('target')?.partitions[groupIndex]?.target"
                        matTooltipPosition="above"
                      >
                        <input
                          matInput
                          [placeholder]="'home.new-experiment.design.partition-id.placeholder.text' | translate"
                          formControlName="target"
                          [matAutocomplete]="autoCompleteExperimentIds"
                        />
                        <mat-autocomplete #autoCompleteExperimentIds="matAutocomplete" panelWidth="fit-content">
                          <mat-option *ngFor="let target of filteredExpIds$[groupIndex] | async" [value]="target">
                            {{ target }}
                          </mat-option>
                        </mat-autocomplete>
                      </span>
                    </mat-form-field>
                  </ng-container>
                </mat-cell>
              </ng-container>

              <!-- ExcludeIfReached Column -->
              <ng-container matColumnDef="excludeIfReached">
                <mat-header-cell class="ft-14-700" *matHeaderCellDef>
                  {{ 'home.new-experiment.design.exclude-if-reached.text' | translate }}
                </mat-header-cell>
                <mat-cell *matCellDef="let element; let groupIndex = index" [formGroupName]="groupIndex">
                  <mat-checkbox
                    class="ft-8-100"
                    color="primary"
                    [disabled]="(decisionPointsTableEditIndex$ | async) !== groupIndex"
                    formControlName="excludeIfReached"
                  >
                  </mat-checkbox>
                </mat-cell>
              </ng-container>

              <!-- Actions Column -->
              <ng-container matColumnDef="actions">
                <mat-header-cell *matHeaderCellDef class="ft-14-700"></mat-header-cell>
                <mat-cell *matCellDef="let rowData; let rowIndex = index" class="actions-cell">
                  <button
                    type="button"
                    class="row-action-btn"
                    [disabled]="(isFormLockedForEdit$ | async) && (decisionPointsTableEditIndex$ | async) !== rowIndex"
                    (click)="handleDecisionPointTableEditClick(rowIndex, rowData.getRawValue())"
                  >
                    <!-- Edit Icon -->
                    <ng-container *ngIf="(decisionPointsTableEditIndex$ | async) !== rowIndex">
                      <mat-icon class="icon">create</mat-icon>
                    </ng-container>

                    <!-- Done Icon -->
                    <ng-container *ngIf="(decisionPointsTableEditIndex$ | async) === rowIndex">
                      <mat-icon class="icon">done</mat-icon>
                    </ng-container>
                  </button>

                  <button
                    type="button"
                    class="row-action-btn"
                    [disabled]="(isFormLockedForEdit$ | async) && (decisionPointsTableEditIndex$ | async) !== rowIndex"
                    (click)="handleDecisionPointTableClearOrRemoveRow(rowIndex)"
                  >
                    <ng-container *ngIf="(decisionPointsTableEditIndex$ | async) !== rowIndex">
                      <mat-icon class="icon">delete_outline</mat-icon>
                    </ng-container>
                    <ng-container *ngIf="(decisionPointsTableEditIndex$ | async) === rowIndex">
                      <mat-icon class="icon">clear</mat-icon>
                    </ng-container>
                  </button>
                </mat-cell>
              </ng-container>

              <mat-header-row *matHeaderRowDef="partitionDisplayedColumns; sticky: true"></mat-header-row>
              <mat-row
                *matRowDef="let row; let rowIndex = index; columns: partitionDisplayedColumns"
                [ngClass]="{
                  'row-is-locked':
                    (isFormLockedForEdit$ | async) && (decisionPointsTableEditIndex$ | async) !== rowIndex
                }"
              ></mat-row>
            </mat-table>
            <button
              type="button"
              class="ft-12-700 add-partition"
              *ngIf="!experimentInfo"
              [ngClass]="{ 'add-partition--disabled': (isFormLockedForEdit$ | async) }"
              [disabled]="isFormLockedForEdit$ | async"
              (click)="addConditionOrPartition('partition')"
            >
              +
              {{ 'home.new-experiment.design.add-experiment-partition.text' | translate }}
            </button>
            <button
              type="button"
              class="ft-12-700 add-partition"
              *ngIf="experimentInfo"
              [ngClass]="{ 'add-partition--disabled': !isExperimentEditable || (isFormLockedForEdit$ | async) }"
              [disabled]="!isExperimentEditable || (isFormLockedForEdit$ | async)"
              (click)="addConditionOrPartition('partition')"
            >
              +
              {{ 'home.new-experiment.design.add-experiment-partition.text' | translate }}
            </button>
          </ng-container>
          <div class="validation-container">
            <span class="ft-14-600 validation-message" *ngFor="let error of partitionPointErrors">{{ error }}</span>
            <span
              class="ft-14-600 validation-message"
              *ngIf="partitionCountError"
              [innerHTML]="partitionCountError"
            ></span>
            <!-- If experiment point and id are not from predefined value -->
            <span class="ft-14-600 validation-message" *ngFor="let error of expPointAndIdErrors">{{ error }}</span>
          </div>

          <!-- Condition table -->
          <span class="title">{{ 'home.new-experiment.design.condition.text' | translate }}</span>
          <!-- apply equal condition weights -->
          <div class="conditions-header-container">
            <mat-checkbox
              class="ft-13-700"
              color="primary"
              [disabled]="!isExperimentEditable"
              [checked]="equalWeightFlag"
              (change)="changeEqualWeightFlag($event)"
            >
              {{ 'home.new-experiment.design.equal-assignment-weights.text' | translate }}
            </mat-checkbox>
          </div>
          <ng-container>
            <mat-table
              class="condition-table"
              [dataSource]="conditionDataSource"
              formArrayName="conditions"
              #conditionTable
            >
              <!-- CONDITION NAME Column -->
              <ng-container matColumnDef="conditionCode">
                <mat-header-cell class="ft-14-700" *matHeaderCellDef>
                  {{ 'home.new-experiment.design.name.text' | translate }}
                </mat-header-cell>
                <mat-cell *matCellDef="let element; let groupIndex = index" [formGroupName]="groupIndex">
                  <ng-container *ngIf="(conditionsTableEditIndex$ | async) !== groupIndex">
                    <span [matTooltip]="condition.at(groupIndex).get('conditionCode').value" matTooltipPosition="above">
                      {{ condition.at(groupIndex).get('conditionCode').value | truncate: 35 }}
                    </span>
                  </ng-container>
                  <ng-container *ngIf="(conditionsTableEditIndex$ | async) === groupIndex">
                    <mat-form-field floatLabel="never">
                      <span
                        [matTooltip]="
                          experimentDesignForm.getRawValue('conditionCode')?.conditions[groupIndex]?.conditionCode
                        "
                        matTooltipPosition="above"
                      >
                        <input
                          matInput
                          [placeholder]="'home.new-experiment.design.condition.placeholder.text' | translate"
                          formControlName="conditionCode"
                          [matAutocomplete]="autoCompleteConditionCodes"
                        />
                        <mat-autocomplete #autoCompleteConditionCodes="matAutocomplete" panelWidth="fit-content">
                          <mat-option
                            *ngFor="let conditionCode of filteredConditionCodes$[groupIndex] | async"
                            [value]="conditionCode"
                          >
                            {{ conditionCode }}
                          </mat-option>
                        </mat-autocomplete>
                      </span>
                    </mat-form-field>
                  </ng-container>
                </mat-cell>
              </ng-container>

              <!-- ASSIGNMENT WEIGHT Column -->
              <ng-container matColumnDef="assignmentWeight">
                <mat-header-cell class="ft-14-700" *matHeaderCellDef style="justify-content: right">
                  {{ 'home-global.assignment-weight.text' | translate }}
                </mat-header-cell>
                <mat-cell
                  *matCellDef="let element; let groupIndex = index"
                  [formGroupName]="groupIndex"
                  style="justify-content: center"
                >
                  <ng-container *ngIf="(conditionsTableEditIndex$ | async) !== groupIndex">
                    <div class="assignment-weight-readonly align-right">
                      {{ condition.at(groupIndex).get('assignmentWeight').value | truncate: 35 }}
                    </div>
                  </ng-container>
                  <ng-container *ngIf="(conditionsTableEditIndex$ | async) === groupIndex">
                    <mat-form-field floatLabel="never" class="align-right">
                      <input
                        type="number"
                        matInput
                        [placeholder]="'home.new-experiment.design.assignment-weight.placeholder.text' | translate"
                        formControlName="assignmentWeight"
                        autocomplete="off"
                      />
                    </mat-form-field>
                  </ng-container>
                </mat-cell>
              </ng-container>

              <!-- DESCRIPTION Column -->
              <ng-container matColumnDef="description">
                <mat-header-cell class="ft-14-700" *matHeaderCellDef>
                  {{ 'home.new-experiment.design.description.text' | translate }}
                </mat-header-cell>
                <mat-cell *matCellDef="let rowData; let groupIndex = index" [formGroupName]="groupIndex">
                  <ng-container *ngIf="(conditionsTableEditIndex$ | async) !== groupIndex">
                    <span [matTooltip]="condition.at(groupIndex).get('description').value" matTooltipPosition="above">
                      {{ condition.at(groupIndex).get('description').value | truncate: 35 }}
                    </span>
                  </ng-container>
                  <ng-container *ngIf="(conditionsTableEditIndex$ | async) === groupIndex">
                    <mat-form-field floatLabel="never">
                      <input
                        matInput
                        [placeholder]="'home.new-experiment.design.description.placeholder.text' | translate"
                        formControlName="description"
                        autocomplete="off"
                      />
                    </mat-form-field>
                  </ng-container>
                </mat-cell>
              </ng-container>

              <!-- Actions Column -->
              <ng-container matColumnDef="actions">
                <mat-header-cell *matHeaderCellDef class="ft-14-700"></mat-header-cell>
                <mat-cell *matCellDef="let rowData; let rowIndex = index" class="actions-cell">
                  <button
                    type="button"
                    class="row-action-btn"
                    [disabled]="(isFormLockedForEdit$ | async) && (conditionsTableEditIndex$ | async) !== rowIndex"
                    (click)="handleConditionTableEditClick(rowIndex, rowData.getRawValue())"
                  >
                    <!-- Edit Icon -->
                    <ng-container *ngIf="(conditionsTableEditIndex$ | async) !== rowIndex">
                      <mat-icon class="icon">create</mat-icon>
                    </ng-container>

                    <!-- Done Icon -->
                    <ng-container *ngIf="(conditionsTableEditIndex$ | async) === rowIndex">
                      <mat-icon class="icon">done</mat-icon>
                    </ng-container>
                  </button>

                  <button
                    type="button"
                    class="row-action-btn"
                    [disabled]="(isFormLockedForEdit$ | async) && (conditionsTableEditIndex$ | async) !== rowIndex"
                    (click)="handleConditionTableClearOrRemoveRow(rowIndex)"
                  >
                    <ng-container *ngIf="(conditionsTableEditIndex$ | async) !== rowIndex">
                      <mat-icon class="icon">delete_outline</mat-icon>
                    </ng-container>
                    <ng-container *ngIf="(conditionsTableEditIndex$ | async) === rowIndex">
                      <mat-icon class="icon">clear</mat-icon>
                    </ng-container>
                  </button>
                </mat-cell>
              </ng-container>

              <mat-header-row *matHeaderRowDef="conditionDisplayedColumns; sticky: true"></mat-header-row>
              <mat-row
                *matRowDef="let row; let rowIndex = index; columns: conditionDisplayedColumns"
                [ngClass]="{
                  'row-is-locked': (isFormLockedForEdit$ | async) && (conditionsTableEditIndex$ | async) !== rowIndex
                }"
              ></mat-row>
            </mat-table>
            <button
              type="button"
              class="ft-12-700 add-condition"
              *ngIf="!experimentInfo"
              [ngClass]="{ 'add-condition--disabled': (isFormLockedForEdit$ | async) }"
              [disabled]="isFormLockedForEdit$ | async"
              (click)="addConditionOrPartition('condition')"
            >
              + {{ 'home.new-experiment.design.add-condition.text' | translate }}
            </button>
            <button
              type="button"
              class="ft-12-700 add-condition"
              *ngIf="experimentInfo"
              [ngClass]="{ 'add-condition--disabled': !isExperimentEditable || (isFormLockedForEdit$ | async) }"
              [disabled]="!isExperimentEditable || (isFormLockedForEdit$ | async)"
              (click)="addConditionOrPartition('condition')"
            >
              + {{ 'home.new-experiment.design.add-condition.text' | translate }}
            </button>
          </ng-container>
          <div class="validation-container">
            <span
              class="ft-14-600 validation-message"
              *ngIf="experimentDesignForm.errors?.assignmentWeightsSumError"
              [innerHTML]="'home.new-experiment.design.assignment-weight-validation.text' | translate"
            ></span>
            <span class="ft-14-600 validation-message" *ngFor="let error of conditionCodeErrors">{{ error }} </span>
            <span
              class="ft-14-600 validation-message"
              *ngIf="conditionCountError"
              [innerHTML]="conditionCountError"
            ></span>
          </div>
        </section>

        <div>
          <br />
          <br />
          <app-aliases-table
            [designData$]="designData$"
            [experimentInfo]="experimentInfo"
            (aliasTableData$)="handleAliasTableDataChange($event)"
            (hideAliasTable)="scrollToConditionsTable()"
          >
          </app-aliases-table>
          <br />
        </div>
      </form>
    </section>
  </section>

  <section class="shared-modal--buttons-container sticky">
    <span class="shared-modal--buttons-left">
      <button
        matStepperPrevious
        mat-raised-button
        class="shared-modal--modal-btn btn-back default-button"
        [class.default-button--disabled]="isFormLockedForEdit$ | async"
        [disabled]="isFormLockedForEdit$ | async"
        (click)="handleBackBtnClick()"
      >
        {{ 'global.back.text' | translate }}
      </button>
    </span>
    <span class="shared-modal--buttons-right">
      <button
        type="button"
        mat-raised-button
        class="shared-modal--modal-btn"
        (click)="emitEvent(NewExperimentDialogEvents.CLOSE_DIALOG)"
      >
        {{ 'global.cancel.text' | translate }}
      </button>
      <button
        type="button"
        mat-raised-button
        class="shared-modal--modal-btn default-button"
        (click)="emitEvent(NewExperimentDialogEvents.SEND_FORM_DATA)"
        [class.default-button--disabled]="isFormLockedForEdit$ | async"
        [disabled]="isFormLockedForEdit$ | async"
      >
        {{ 'global.next.text' | translate }}
      </button>
      <button
        type="button"
        *ngIf="experimentInfo"
        mat-raised-button
        class="shared-modal--modal-btn default-button"
        [class.default-button--disabled]= "(isFormLockedForEdit$ | async) || !isExperimentEditable"
        [disabled]="(isFormLockedForEdit$ | async) || !isExperimentEditable"
        (click)="emitEvent(NewExperimentDialogEvents.SAVE_DATA)"
      >
        {{ 'global.save.text' | translate }}
      </button>
    </span>
  </section>
</div>
