<form class="experiment-design" [formGroup]="experimentDesignForm">
  <!-- Partition Table -->
  <ng-container>
    <mat-table
      class="partition-table"
      [dataSource]="partitionDataSource"
      formArrayName="partitions"
      #partitionTable
    >
      <!-- Site Column -->
      <ng-container matColumnDef="expPoint">
        <mat-header-cell class="ft-14-700" *matHeaderCellDef>
          {{ 'home.new-experiment.design.partition-point.text' | translate }}
        </mat-header-cell>
        <mat-cell
          *matCellDef="let element; let groupIndex = index"
          [formGroupName]="groupIndex"
        >
          <mat-form-field floatLabel="never">
            <span
              [matTooltip]="experimentDesignForm.getRawValue('expPoint')?.partitions[groupIndex]?.expPoint"
              matTooltipPosition="above"
              >
              <input
                matInput
                [placeholder]="
                  'home.new-experiment.design.partition-point.placeholder.text'
                    | translate
                "
                formControlName="expPoint"
                [matAutocomplete]="autoCompleteExperimentPoints"
              />
              <mat-autocomplete #autoCompleteExperimentPoints="matAutocomplete" panelWidth="fit-content">
                <mat-option *ngFor="let expPoint of filteredExpPoints$[groupIndex] | async" [value]="expPoint">
                  {{ expPoint }}
                </mat-option>
              </mat-autocomplete>
            </span>
          </mat-form-field>
        </mat-cell>
      </ng-container>

      <!-- Target Column -->
      <ng-container matColumnDef="expId">
        <mat-header-cell class="ft-14-700" *matHeaderCellDef>
          {{ 'home.new-experiment.design.partition-id.text' | translate }}
        </mat-header-cell>
        <mat-cell
          *matCellDef="let element; let groupIndex = index"
          [formGroupName]="groupIndex"
        >
          <mat-form-field floatLabel="never">
            <span
              [matTooltip]="experimentDesignForm.getRawValue('expId')?.partitions[groupIndex]?.expId"
              matTooltipPosition="above">
              <input
                matInput
                [placeholder]="
                  'home.new-experiment.design.partition-id.placeholder.text'
                    | translate
                "
                formControlName="expId"
                [matAutocomplete]="autoCompleteExperimentIds"
              />
              <mat-autocomplete #autoCompleteExperimentIds="matAutocomplete" panelWidth="fit-content">
                <mat-option *ngFor="let expId of filteredExpIds$[groupIndex] | async" [value]="expId">
                  {{ expId }}
                </mat-option>
              </mat-autocomplete>
            </span>
          </mat-form-field>
        </mat-cell>
      </ng-container>

      <!-- Required Column -->
      <ng-container matColumnDef="requiredId">
        <mat-header-cell class="ft-14-700" *matHeaderCellDef>
          {{ 'home.new-experiment.design.required.text' | translate }}
        </mat-header-cell>
        <mat-cell
          *matCellDef="let element; let groupIndex = index"
          [formGroupName]="groupIndex"
        >
          <!-- <mat-form-field floatLabel="never"> -->
            <mat-checkbox
                  class="ft-8-100"
                  color="primary"
                  >
          </mat-checkbox>
          <!-- </mat-form-field> -->
        </mat-cell>
      </ng-container>

      <ng-container matColumnDef="removePartition">
        <mat-header-cell class="ft-14-700" *matHeaderCellDef></mat-header-cell>
        <mat-cell
          *matCellDef="let element; let groupIndex = index"
          [formGroupName]="groupIndex"
        >
          <mat-icon
            class="remove-icon"
            (click)="removeConditionOrPartition('partition', groupIndex)"
          >
            delete_outline
          </mat-icon>
        </mat-cell>
      </ng-container>

      <mat-header-row
        *matHeaderRowDef="partitionDisplayedColumns; sticky: true"
      ></mat-header-row>
      <mat-row *matRowDef="let row; columns: partitionDisplayedColumns"></mat-row>
    </mat-table>
    
    <button
      type="button"
      class="ft-12-700 add-partition"
      (click)="addConditionOrPartition('partition')"
    >
      +
      {{ 'home.new-experiment.design.add-experiment-partition.text' | translate }}
    </button>
  </ng-container>
  <span
    class="ft-14-600 validation-message"
    *ngFor="let error of partitionPointErrors"
  >{{ error }} </span>
  <span
      class="ft-14-600 validation-message"
      *ngIf="partitionCountError"
      [innerHTML]="partitionCountError"
  ></span>
  <!-- If experiment point and id are not from predefined value -->
  <span
    class="ft-14-600 validation-message"
    *ngFor="let error of expPointAndIdErrors"
  >{{ error }} </span>
  <br>
  <br>
  <br>
  <!-- apply equal condition weights -->
  <div class="header-group">
    <mat-checkbox
    class="ft-8-100"
    color="primary"
    (change)="applyEqualWeight($event)">
    {{ 'home.new-experiment.design.equal-assignment-weights.text' | translate }}
    </mat-checkbox>
  </div>
  <!-- Condition table -->
  <ng-container>
    <mat-table
      class="condition-table"
      [dataSource]="conditionDataSource"
      formArrayName="conditions"
      #conditionTable
    >
      <!-- CONDITION NAME Column -->
      <ng-container matColumnDef="conditionCode">
        <mat-header-cell class="ft-14-700" *matHeaderCellDef>
          {{ 'global.condition.text' | translate }}
        </mat-header-cell>
        <mat-cell
          *matCellDef="let element; let groupIndex = index"
          [formGroupName]="groupIndex"
        >
          <mat-form-field floatLabel="never">
            <span 
              [matTooltip]="experimentDesignForm.getRawValue('conditionCode')?.conditions[groupIndex]?.conditionCode"
              matTooltipPosition="above"
              >
              <input
                matInput
                [placeholder]="
                  'home.new-experiment.design.condition.placeholder.text'
                    | translate
                "
                formControlName="conditionCode"
                [matAutocomplete]="autoCompleteConditionCodes"
              />
              <mat-autocomplete #autoCompleteConditionCodes="matAutocomplete" panelWidth="fit-content">
                <mat-option *ngFor="let conditionCode of filteredConditionCodes$[groupIndex] | async" [value]="conditionCode">
                  {{ conditionCode }}
                </mat-option>
              </mat-autocomplete>
            </span>
          </mat-form-field>
        </mat-cell>
      </ng-container>

      <!-- ASSIGNMENT WEIGHT Column -->
      <ng-container matColumnDef="assignmentWeight">
        <mat-header-cell class="ft-14-700" *matHeaderCellDef>
          {{ 'home-global.assignment-weight.text' | translate }}
        </mat-header-cell>
        <mat-cell
          *matCellDef="let element; let groupIndex = index"
          [formGroupName]="groupIndex"
        >
          <mat-form-field floatLabel="never">
            <input
              type="string"
              matInput
              [placeholder]="
                'home.new-experiment.design.assignment-weight.placeholder.text'
                  | translate
              "
              formControlName="assignmentWeight"
            />
          </mat-form-field>
        </mat-cell>
      </ng-container>

      <!-- DESCRIPTION Column -->
      <ng-container matColumnDef="description">
        <mat-header-cell class="ft-14-700" *matHeaderCellDef>
          {{ 'home.new-experiment.design.description.text' | translate }}
        </mat-header-cell>
        <mat-cell
          *matCellDef="let element; let groupIndex = index"
          [formGroupName]="groupIndex"
        >
          <mat-form-field floatLabel="never">
            <input
              matInput
              [placeholder]="
                'home.new-experiment.design.description.placeholder.text'
                  | translate
              "
              formControlName="description"
            />
          </mat-form-field>
        </mat-cell>
      </ng-container>

      <ng-container matColumnDef="removeCondition">
        <mat-header-cell class="ft-14-700" *matHeaderCellDef></mat-header-cell>
        <mat-cell
          *matCellDef="let element; let groupIndex = index"
          [formGroupName]="groupIndex"
        >
          <mat-icon
            class="remove-icon"
            (click)="removeConditionOrPartition('condition', groupIndex)"
          >
            delete_outline
          </mat-icon>
        </mat-cell>
      </ng-container>
      <mat-header-row *matHeaderRowDef="conditionDisplayedColumns; sticky: true"></mat-header-row>
      <mat-row
        *matRowDef="let row; columns: conditionDisplayedColumns"
      ></mat-row>
    </mat-table>
    <span
      class="ft-14-600 validation-message"
      *ngIf="experimentDesignForm.errors?.assignmentWeightsSumError"
      [innerHTML]="'home.new-experiment.design.assignment-weight-validation.text' | translate"
    ></span>
    <span
    class="ft-14-600 validation-message"
    *ngFor="let error of conditionCodeErrors"
    >{{ error }} </span>
    <span
      class="ft-14-600 validation-message"
      *ngIf="conditionCountError"
      [innerHTML]="conditionCountError"
    ></span>
    <button
      type="button"
      class="ft-12-700 add-condition"
      (click)="addConditionOrPartition('condition')"
    >
      + {{ 'home.new-experiment.design.add-condition.text' | translate }}
    </button>
  </ng-container>
  <br>
  <br>
  <br>
  <div class="button-container">
    <button
      matStepperPrevious
      mat-raised-button
      class="modal-btn btn-back default-button"
    >
      {{ 'global.back.text' | translate }}
    </button>
    <div>
      <button
        type="button"
        mat-raised-button
        class="modal-btn"
        (click)="emitEvent(NewExperimentDialogEvents.CLOSE_DIALOG)"
      >
        {{ 'global.cancel.text' | translate }}
      </button> 
      <button
        type="button"
        mat-raised-button
        class="modal-btn default-button"
        (click)="emitEvent(NewExperimentDialogEvents.SEND_FORM_DATA)"
      >
        {{ 'global.next.text' | translate }}
      </button>
      <button
        type="button"
        *ngIf="experimentInfo"
        mat-raised-button
        class="modal-btn default-button"
        (click)="emitEvent(NewExperimentDialogEvents.SAVE_DATA)"
      >
        {{ 'global.update.text' | translate }}
      </button>
    </div>
  </div>
</form>
