<div class="shared-modal--step-container scrollable" #stepContainer>
  <section class="shared-modal--form-container">
    <section class="factorial-experiment-form">
      <form class="experiment-design" [formGroup]="factorialExperimentDesignForm">
        <section class="factorial-experiment-factors-levels-view">
          <div class="decision-point-header-container">
            <span class="title">{{ 'home.new-experiment.design.decision-point.text' | translate }}</span>
          </div>
          <!-- Decision Point Table -->
          <ng-container *ngIf="decisionPoints?.length; else initialDecisionPointMessage">
            <mat-table
              class="decision-point-table"
              [dataSource]="decisionPointDataSource"
              formArrayName="decisionPoints"
              #decisionPointTable
            >
              <!-- Site Column -->
              <ng-container matColumnDef="site">
                <mat-header-cell class="ft-14-700" *matHeaderCellDef>
                  {{ 'home.new-experiment.design.decision-point-site.text' | translate }}
                </mat-header-cell>
                <mat-cell *matCellDef="let element; let groupIndex = index" [formGroupName]="groupIndex">
                  <ng-container *ngIf="(decisionPointsTableEditIndex$ | async) !== groupIndex">
                    <span [matTooltip]="decisionPoints.at(groupIndex).get('site').value" matTooltipPosition="above">
                      {{ decisionPoints.at(groupIndex).get('site').value | truncate: 35 }}
                    </span>
                  </ng-container>
                  <ng-container *ngIf="(decisionPointsTableEditIndex$ | async) === groupIndex">
                    <mat-form-field floatLabel="never">
                      <span [matTooltip]="decisionPoints.at(groupIndex).get('site').value" matTooltipPosition="above">
                        <input
                          matInput
                          [placeholder]="'home.new-experiment.design.decision-point-site.placeholder.text' | translate"
                          formControlName="site"
                          [matAutocomplete]="autoCompleteSites"
                        />
                        <mat-autocomplete #autoCompleteSites="matAutocomplete" panelWidth="fit-content">
                          <mat-option *ngFor="let site of filteredSites$[groupIndex] | async" [value]="site">
                            {{ site }}
                          </mat-option>
                        </mat-autocomplete>
                      </span>
                    </mat-form-field>
                  </ng-container>
                </mat-cell>
              </ng-container>

              <!-- Target Column -->
              <ng-container matColumnDef="target">
                <mat-header-cell class="ft-14-700" *matHeaderCellDef>
                  {{ 'home.new-experiment.design.decision-point-target.text' | translate }}
                </mat-header-cell>
                <mat-cell *matCellDef="let element; let groupIndex = index" [formGroupName]="groupIndex">
                  <ng-container *ngIf="(decisionPointsTableEditIndex$ | async) !== groupIndex">
                    <span [matTooltip]="decisionPoints.at(groupIndex).get('target').value" matTooltipPosition="above">
                      {{ decisionPoints.at(groupIndex).get('target').value | truncate: 35 }}
                    </span>
                  </ng-container>
                  <ng-container *ngIf="(decisionPointsTableEditIndex$ | async) === groupIndex">
                    <mat-form-field floatLabel="never">
                      <span [matTooltip]="decisionPoints.at(groupIndex).get('target').value" matTooltipPosition="above">
                        <input
                          matInput
                          [placeholder]="
                            'home.new-experiment.design.decision-point-target.placeholder.text' | translate
                          "
                          formControlName="target"
                          [matAutocomplete]="autoCompleteTargets"
                        />
                        <mat-autocomplete #autoCompleteTargets="matAutocomplete" panelWidth="fit-content">
                          <mat-option *ngFor="let target of filteredTargets$[groupIndex] | async" [value]="target">
                            {{ target }}
                          </mat-option>
                        </mat-autocomplete>
                      </span>
                    </mat-form-field>
                  </ng-container>
                </mat-cell>
              </ng-container>

              <!-- ExcludeIfReached Column -->
              <ng-container matColumnDef="excludeIfReached">
                <mat-header-cell class="ft-14-700" *matHeaderCellDef>
                  {{ 'home.new-experiment.design.exclude-if-reached.text' | translate }}
                </mat-header-cell>
                <mat-cell *matCellDef="let element; let groupIndex = index" [formGroupName]="groupIndex">
                  <mat-checkbox
                    class="ft-8-100"
                    color="primary"
                    [disabled]="(decisionPointsTableEditIndex$ | async) !== groupIndex"
                    formControlName="excludeIfReached"
                  >
                  </mat-checkbox>
                </mat-cell>
              </ng-container>

              <!-- Actions Column -->
              <ng-container matColumnDef="actions">
                <mat-header-cell *matHeaderCellDef class="ft-14-700"></mat-header-cell>
                <mat-cell *matCellDef="let rowData; let rowIndex = index" class="actions-cell">
                  <button
                    type="button"
                    class="row-action-btn"
                    [disabled]="(isFormLockedForEdit$ | async) && (decisionPointsTableEditIndex$ | async) !== rowIndex"
                    (click)="handleDecisionPointTableEditClick(rowIndex, rowData.getRawValue())"
                  >
                    <!-- Edit Icon -->
                    <ng-container *ngIf="(decisionPointsTableEditIndex$ | async) !== rowIndex">
                      <mat-icon class="icon">create</mat-icon>
                    </ng-container>
                    <!-- Done Icon -->
                    <ng-container *ngIf="(decisionPointsTableEditIndex$ | async) === rowIndex">
                      <mat-icon class="icon">done</mat-icon>
                    </ng-container>
                  </button>
                  <button
                    type="button"
                    class="row-action-btn"
                    [disabled]="(isFormLockedForEdit$ | async) && (decisionPointsTableEditIndex$ | async) !== rowIndex"
                    (click)="handleDecisionPointTableClearOrRemoveRow(rowIndex)"
                  >
                    <!-- Delete Icon -->
                    <ng-container *ngIf="(decisionPointsTableEditIndex$ | async) !== rowIndex">
                      <mat-icon class="icon">delete_outline</mat-icon>
                    </ng-container>
                    <!-- Cancel/Clear Icon -->
                    <ng-container *ngIf="(decisionPointsTableEditIndex$ | async) === rowIndex">
                      <mat-icon class="icon">clear</mat-icon>
                    </ng-container>
                  </button>
                </mat-cell>
              </ng-container>

              <mat-header-row *matHeaderRowDef="decisionPointDisplayedColumns; sticky: true"></mat-header-row>
              <mat-row
                *matRowDef="let row; let rowIndex = index; columns: decisionPointDisplayedColumns"
                [ngClass]="{
                  'row-is-locked':
                    (isFormLockedForEdit$ | async) && (decisionPointsTableEditIndex$ | async) !== rowIndex
                }"
              ></mat-row>
            </mat-table>
          </ng-container>
          <ng-container>
            <ng-template #initialDecisionPointMessage>
              <br />
              <div class="no-decision-point-message-container">
                <span
                  class="ft-14-600 no-decision-point-message"
                  [innerHTML]="'home.new-experiment.design.decision-point.inital.include-message' | translate"
                ></span>
              </div>
            </ng-template>
          </ng-container>
          <button
            type="button"
            class="ft-12-700 add-decision-point"
            *ngIf="!experimentInfo"
            [ngClass]="{ 'add-decision-point--disabled': (isFormLockedForEdit$ | async) }"
            [disabled]="isFormLockedForEdit$ | async"
            (click)="addDecisionPoint()"
          >
            +
            {{ 'home.new-experiment.design.add-experiment-decision-point.text' | translate }}
          </button>
          <button
            type="button"
            class="ft-12-700 add-decision-point"
            *ngIf="experimentInfo"
            [ngClass]="{ 'add-decision-point--disabled': !isExperimentEditable || (isFormLockedForEdit$ | async) }"
            [disabled]="!isExperimentEditable || (isFormLockedForEdit$ | async)"
            (click)="addDecisionPoint()"
          >
            +
            {{ 'home.new-experiment.design.add-experiment-decision-point.text' | translate }}
          </button>
          <div class="validation-container">
            <span class="ft-14-600 validation-message" *ngFor="let error of decisionPointErrors">{{ error }}</span>
            <span
              class="ft-14-600 validation-message"
              *ngIf="decisionPointCountError"
              [innerHTML]="decisionPointCountError"
            ></span>
          </div>

          <div class="factors-header-container">
            <span class="title">{{ 'home.new-experiment.design.factor.text' | translate }}</span>
          </div>
          <!-- Factors Table -->
          <ng-container *ngIf="factor?.length; else initialFactorsMessage">
            <mat-table
              class="factor-table"
              [dataSource]="factorDataSource"
              #factorTable
              formArrayName="factors"
              multiTemplateDataRows
            >
              <!-- Expand Icon Column -->
              <ng-container matColumnDef="expandIcon">
                <mat-header-cell class="ft-14-700" *matHeaderCellDef></mat-header-cell>
                <mat-cell
                  *matCellDef="let element; let factorIndex = dataIndex"
                  [formGroupName]="factorIndex"
                  style="justify-content: flex-start"
                >
                  <button
                    mat-icon-button
                    [disabled]="(isFormLockedForEdit$ | async) && (factorsTableEditIndex$ | async) === factorIndex"
                    (click)="expandFactor(factorIndex)"
                  >
                    <mat-icon [class.active]="factorIndex === expandedId">play_arrow</mat-icon>
                  </button>
                </mat-cell>
              </ng-container>

              <!-- Factor Column -->
              <ng-container matColumnDef="factor">
                <mat-header-cell class="ft-14-700" *matHeaderCellDef>
                  {{ 'home.new-experiment.design.factor-name.text' | translate }}
                </mat-header-cell>
                <mat-cell
                  *matCellDef="let element; let factorIndex = dataIndex"
                  [formGroupName]="factorIndex"
                  [ngClass]="{
                    'row-is-locked':
                      ((isFormLockedForEdit$ | async) &&
                        (factorsTableEditIndex$ | async) !== null &&
                        (factorsTableEditIndex$ | async) !== factorIndex) ||
                      (levelsTableEditIndex$ | async) !== null
                  }"
                >
                  <ng-container *ngIf="(factorsTableEditIndex$ | async) !== factorIndex">
                    <span
                      [matTooltip]="factorialExperimentDesignForm.getRawValue('factor')?.factors[factorIndex]?.name"
                      matTooltipPosition="above"
                    >
                      {{
                        factorialExperimentDesignForm.getRawValue('factor')?.factors[factorIndex]?.name | truncate: 35
                      }}
                    </span>
                  </ng-container>
                  <ng-container
                    *ngIf="
                      (isFormLockedForEdit$ | async) &&
                      (factorsTableEditIndex$ | async) === factorIndex &&
                      (levelsTableEditIndex$ | async) === null
                    "
                  >
                    <mat-form-field floatLabel="never">
                      <span
                        [matTooltip]="factorialExperimentDesignForm.getRawValue('factor')?.factors[factorIndex]?.name"
                        matTooltipPosition="above"
                      >
                        <input
                          matInput
                          [placeholder]="'home.new-experiment.design.factor.placeholder.text' | translate"
                          formControlName="name"
                          [value]="name"
                          autocomplete="off"
                        />
                      </span>
                    </mat-form-field>
                  </ng-container>
                </mat-cell>
              </ng-container>

              <!-- DESCRIPTION Column -->
              <ng-container matColumnDef="description">
                <mat-header-cell class="ft-14-700" *matHeaderCellDef>
                  {{ 'home.new-experiment.design.description.text' | translate }}
                </mat-header-cell>
                <mat-cell
                  *matCellDef="let element; let factorIndex = dataIndex"
                  [formGroupName]="factorIndex"
                  [ngClass]="{
                    'row-is-locked':
                      ((isFormLockedForEdit$ | async) &&
                        (factorsTableEditIndex$ | async) !== null &&
                        (factorsTableEditIndex$ | async) !== factorIndex) ||
                      (levelsTableEditIndex$ | async) !== null
                  }"
                >
                  <ng-container *ngIf="(factorsTableEditIndex$ | async) !== factorIndex">
                    <span
                      [matTooltip]="
                        factorialExperimentDesignForm.getRawValue('factor')?.factors[factorIndex]?.description
                      "
                      matTooltipPosition="above"
                    >
                      {{
                        factorialExperimentDesignForm.getRawValue('factor')?.factors[factorIndex]?.description
                          | truncate: 35
                      }}
                    </span>
                  </ng-container>
                  <ng-container
                    *ngIf="
                      (isFormLockedForEdit$ | async) &&
                      (factorsTableEditIndex$ | async) === factorIndex &&
                      (levelsTableEditIndex$ | async) === null
                    "
                  >
                    <mat-form-field floatLabel="never">
                      <span
                        [matTooltip]="
                          factorialExperimentDesignForm.getRawValue('factor')?.factors[factorIndex]?.description
                        "
                        matTooltipPosition="above"
                      >
                        <input
                          matInput
                          [placeholder]="'home.new-experiment.design.description.placeholder.text' | translate"
                          formControlName="description"
                          [value]="description"
                        />
                      </span>
                    </mat-form-field>
                  </ng-container>
                </mat-cell>
              </ng-container>
              <!-- Actions Column -->
              <ng-container matColumnDef="actions">
                <mat-header-cell *matHeaderCellDef class="ft-14-700"></mat-header-cell>
                <mat-cell
                  *matCellDef="let rowData; let rowIndex = dataIndex"
                  class="actions-cell"
                  style="justify-content: flex-end"
                  [ngClass]="{
                    'row-is-locked':
                      ((isFormLockedForEdit$ | async) &&
                        (factorsTableEditIndex$ | async) !== null &&
                        (factorsTableEditIndex$ | async) !== rowIndex) ||
                      (levelsTableEditIndex$ | async) !== null
                  }"
                >
                  <button
                    type="button"
                    class="row-action-btn"
                    [disabled]="(isFormLockedForEdit$ | async) && (factorsTableEditIndex$ | async) !== rowIndex"
                    (click)="handleFactorTableEditClick(rowData.getRawValue(), rowIndex)"
                  >
                    <!-- Edit Icon -->
                    <ng-container *ngIf="(factorsTableEditIndex$ | async) !== rowIndex">
                      <mat-icon class="icon">create</mat-icon>
                    </ng-container>
                    <!-- Done Icon -->
                    <ng-container
                      *ngIf="
                        (isFormLockedForEdit$ | async) &&
                        (factorsTableEditIndex$ | async) !== null &&
                        (factorsTableEditIndex$ | async) === rowIndex &&
                        (levelsTableEditIndex$ | async) === null
                      "
                    >
                      <mat-icon class="icon">done</mat-icon>
                    </ng-container>
                  </button>
                  <button
                    type="button"
                    class="row-action-btn"
                    [disabled]="(isFormLockedForEdit$ | async) && (factorsTableEditIndex$ | async) !== rowIndex"
                    (click)="handleFactorTableClearOrRemoveRow(rowIndex)"
                  >
                    <!-- Delete Icon -->
                    <ng-container *ngIf="(factorsTableEditIndex$ | async) !== rowIndex">
                      <mat-icon class="icon">delete_outline</mat-icon>
                    </ng-container>
                    <!-- Cancel/Clear Icon -->
                    <ng-container
                      *ngIf="
                        (isFormLockedForEdit$ | async) &&
                        (factorsTableEditIndex$ | async) !== null &&
                        (factorsTableEditIndex$ | async) === rowIndex &&
                        (levelsTableEditIndex$ | async) === null
                      "
                    >
                      <mat-icon class="icon">clear</mat-icon>
                    </ng-container>
                  </button>
                </mat-cell>
              </ng-container>
              <!-- EXPANDABLE LEVEL TABLE ROW -->
              <ng-container matColumnDef="expandedDetail">
                <mat-cell *matCellDef="let element; let factorIndex = dataIndex" [formGroupName]="factorIndex">
                  <div *ngIf="factorIndex === expandedId" class="level-container">
                    <div class="level-table-container">
                      <mat-table
                        class="level-table"
                        [dataSource]="element.controls.levels.controls"
                        formArrayName="levels"
                        #levelTable
                      >
                        <!-- Level Column -->
                        <ng-container matColumnDef="level">
                          <mat-header-cell class="ft-14-700" *matHeaderCellDef>
                            {{ 'home.new-experiment.design.level-name.text' | translate }}
                          </mat-header-cell>
                          <mat-cell *matCellDef="let element; let levelIndex = index" [formGroupName]="levelIndex">
                            <ng-container
                              *ngIf="
                                ((levelsTableEditIndex$ | async) !== levelIndex &&
                                  (factorsTableIndex$ | async) === factorIndex) ||
                                ((levelsTableEditIndex$ | async) === levelIndex &&
                                  (factorsTableIndex$ | async) !== factorIndex) ||
                                ((levelsTableEditIndex$ | async) !== levelIndex &&
                                  (isFormLockedForEdit$ | async) &&
                                  (factorsTableIndex$ | async) !== factorIndex) ||
                                ((levelsTableEditIndex$ | async) !== levelIndex &&
                                  !(isFormLockedForEdit$ | async) &&
                                  (factorsTableIndex$ | async) !== factorIndex)
                              "
                            >
                              <span
                                [matTooltip]="
                                  factorialExperimentDesignForm.getRawValue('level')?.factors[factorIndex]?.levels[
                                    levelIndex
                                  ]?.name
                                "
                                matTooltipPosition="above"
                              >
                                {{
                                  factorialExperimentDesignForm.getRawValue('level')?.factors[factorIndex]?.levels[
                                    levelIndex
                                  ]?.name | truncate: 35
                                }}
                              </span>
                            </ng-container>
                            <ng-container
                              *ngIf="
                                (levelsTableEditIndex$ | async) === levelIndex &&
                                (factorsTableIndex$ | async) === factorIndex
                              "
                            >
                              <mat-form-field floatLabel="never">
                                <span
                                  [matTooltip]="
                                    factorialExperimentDesignForm.getRawValue('level')?.factors[factorIndex]?.levels[
                                      levelIndex
                                    ]?.name
                                  "
                                  matTooltipPosition="above"
                                >
                                  <input
                                    matInput
                                    [placeholder]="'home.new-experiment.design.level.placeholder.text' | translate"
                                    formControlName="name"
                                    [value]="name"
                                    autocomplete="off"
                                  />
                                </span>
                              </mat-form-field>
                            </ng-container>
                          </mat-cell>
                        </ng-container>

                        <!-- Payload Column -->
                        <ng-container matColumnDef="payload">
                          <mat-header-cell class="ft-14-700" *matHeaderCellDef>
                            {{ 'home.new-experiment.design.payloads.column-header.payload.text' | translate }}
                          </mat-header-cell>
                          <mat-cell
                            *matCellDef="let element; let levelPayloadIndex = index"
                            [formGroupName]="levelPayloadIndex"
                          >
                            <ng-container
                              *ngIf="
                                ((levelsTableEditIndex$ | async) !== levelPayloadIndex &&
                                  (factorsTableIndex$ | async) === factorIndex) ||
                                ((levelsTableEditIndex$ | async) === levelPayloadIndex &&
                                  (factorsTableIndex$ | async) !== factorIndex) ||
                                ((levelsTableEditIndex$ | async) !== levelPayloadIndex &&
                                  (isFormLockedForEdit$ | async) &&
                                  (factorsTableIndex$ | async) !== factorIndex) ||
                                ((levelsTableEditIndex$ | async) !== levelPayloadIndex &&
                                  !(isFormLockedForEdit$ | async) &&
                                  (factorsTableIndex$ | async) !== factorIndex)
                              "
                            >
                              <span
                                [matTooltip]="
                                  factorialExperimentDesignForm.getRawValue('payload')?.factors[factorIndex]?.levels[
                                    levelPayloadIndex
                                  ]?.payload?.value
                                "
                                matTooltipPosition="above"
                              >
                                {{
                                  factorialExperimentDesignForm.getRawValue('payload')?.factors[factorIndex]?.levels[
                                    levelPayloadIndex
                                  ]?.payload?.value | truncate: 35
                                }}
                              </span>
                            </ng-container>
                            <ng-container
                              formGroupName="payload"
                              *ngIf="
                                (levelsTableEditIndex$ | async) === levelPayloadIndex &&
                                (factorsTableIndex$ | async) === factorIndex
                              "
                            >
                              <mat-form-field floatLabel="never">
                                <span
                                  [matTooltip]="
                                    factorialExperimentDesignForm.getRawValue('payload')?.factors[factorIndex]?.levels[
                                      levelPayloadIndex
                                    ]?.payload?.value
                                  "
                                  matTooltipPosition="above"
                                >
                                  <input
                                    matInput
                                    [placeholder]="'home.new-experiment.design.payload.placeholder.text' | translate"
                                    formControlName="value"
                                    [value]="payload?.value"
                                    autocomplete="off"
                                  />
                                </span>
                              </mat-form-field>
                            </ng-container>
                          </mat-cell>
                        </ng-container>

                        <!-- Actions Column -->
                        <ng-container matColumnDef="actions">
                          <mat-header-cell *matHeaderCellDef class="ft-14-700"></mat-header-cell>
                          <mat-cell
                            *matCellDef="let rowData; let rowIndex = index"
                            class="actions-cell"
                            style="justify-content: flex-end"
                            [ngClass]="{
                              'row-is-locked':
                                ((levelsTableEditIndex$ | async) !== null &&
                                  (levelsTableEditIndex$ | async) !== rowIndex &&
                                  (factorsTableIndex$ | async) === factorIndex) ||
                                ((levelsTableEditIndex$ | async) === rowIndex &&
                                  (factorsTableIndex$ | async) !== factorIndex) ||
                                ((levelsTableEditIndex$ | async) !== rowIndex &&
                                  (isFormLockedForEdit$ | async) &&
                                  (factorsTableIndex$ | async) !== factorIndex) ||
                                ((levelsTableEditIndex$ | async) !== null &&
                                  (levelsTableEditIndex$ | async) !== rowIndex &&
                                  !(isFormLockedForEdit$ | async) &&
                                  (factorsTableIndex$ | async) !== factorIndex)
                            }"
                          >
                            <button
                              type="button"
                              class="row-action-btn"
                              [disabled]="
                                (isFormLockedForEdit$ | async) && (levelsTableEditIndex$ | async) !== rowIndex
                              "
                              (click)="handleLevelTableEditClick(rowData.getRawValue(), rowIndex, factorIndex)"
                            >
                              <!-- Edit Icon -->
                              <ng-container
                                *ngIf="
                                  ((levelsTableEditIndex$ | async) !== rowIndex &&
                                    (factorsTableIndex$ | async) === factorIndex) ||
                                  ((levelsTableEditIndex$ | async) === rowIndex &&
                                    (factorsTableIndex$ | async) !== factorIndex) ||
                                  ((levelsTableEditIndex$ | async) !== rowIndex &&
                                    (isFormLockedForEdit$ | async) &&
                                    (factorsTableIndex$ | async) !== factorIndex) ||
                                  ((levelsTableEditIndex$ | async) !== rowIndex &&
                                    !(isFormLockedForEdit$ | async) &&
                                    (factorsTableIndex$ | async) !== factorIndex)
                                "
                              >
                                <mat-icon class="icon">create</mat-icon>
                              </ng-container>
                              <!-- Done Icon -->
                              <ng-container
                                *ngIf="
                                  (levelsTableEditIndex$ | async) === rowIndex &&
                                  (factorsTableIndex$ | async) === factorIndex
                                "
                              >
                                <mat-icon class="icon">done</mat-icon>
                              </ng-container>
                            </button>
                            <button
                              type="button"
                              class="row-action-btn"
                              [disabled]="
                                (isFormLockedForEdit$ | async) && (levelsTableEditIndex$ | async) !== rowIndex
                              "
                              (click)="handleLevelTableClearOrRemoveRow(factorIndex, rowIndex)"
                            >
                              <!-- Delete Icon -->
                              <ng-container
                                *ngIf="
                                  ((levelsTableEditIndex$ | async) !== rowIndex &&
                                    (factorsTableIndex$ | async) === factorIndex) ||
                                  ((levelsTableEditIndex$ | async) === rowIndex &&
                                    (factorsTableIndex$ | async) !== factorIndex) ||
                                  ((levelsTableEditIndex$ | async) !== rowIndex &&
                                    (isFormLockedForEdit$ | async) &&
                                    (factorsTableIndex$ | async) !== factorIndex) ||
                                  ((levelsTableEditIndex$ | async) !== rowIndex &&
                                    !(isFormLockedForEdit$ | async) &&
                                    (factorsTableIndex$ | async) !== factorIndex)
                                "
                              >
                                <mat-icon class="icon">delete_outline</mat-icon>
                              </ng-container>
                              <!-- Cancel/Clear Icon -->
                              <ng-container
                                *ngIf="
                                  (levelsTableEditIndex$ | async) === rowIndex &&
                                  (factorsTableIndex$ | async) === factorIndex
                                "
                              >
                                <mat-icon class="icon">clear</mat-icon>
                              </ng-container>
                            </button>
                          </mat-cell>
                        </ng-container>
                        <mat-header-row *matHeaderRowDef="levelDisplayedColumns; sticky: true"></mat-header-row>
                        <mat-row
                          *matRowDef="let row; let rowIndex = index; columns: levelDisplayedColumns"
                          [ngClass]="{
                            'row-is-locked':
                              ((levelsTableEditIndex$ | async) !== null &&
                                (levelsTableEditIndex$ | async) !== rowIndex &&
                                (factorsTableIndex$ | async) === factorIndex) ||
                              ((levelsTableEditIndex$ | async) === rowIndex &&
                                (factorsTableIndex$ | async) !== factorIndex) ||
                              ((levelsTableEditIndex$ | async) !== rowIndex &&
                                (isFormLockedForEdit$ | async) &&
                                (factorsTableIndex$ | async) !== factorIndex) ||
                              ((levelsTableEditIndex$ | async) !== null &&
                                (levelsTableEditIndex$ | async) !== rowIndex &&
                                !(isFormLockedForEdit$ | async) &&
                                (factorsTableIndex$ | async) !== factorIndex)
                          }"
                        >
                        </mat-row>
                      </mat-table>
                    </div>
                    <button
                      type="button"
                      class="ft-12-700 add-level"
                      *ngIf="!experimentInfo"
                      [ngClass]="{ 'add-level--disabled': (isFormLockedForEdit$ | async) }"
                      [disabled]="isFormLockedForEdit$ | async"
                      (click)="addLevel(factorIndex)"
                    >
                      +
                      {{ 'home.new-experiment.design.add-experiment-factor-level.text' | translate }}
                    </button>
                    <button
                      type="button"
                      class="ft-12-700 add-level"
                      *ngIf="experimentInfo"
                      [ngClass]="{ 'add-level--disabled': !isExperimentEditable || (isFormLockedForEdit$ | async) }"
                      [disabled]="!isExperimentEditable || (isFormLockedForEdit$ | async)"
                      (click)="addLevel(factorIndex)"
                    >
                      +
                      {{ 'home.new-experiment.design.add-experiment-factor-level.text' | translate }}
                    </button>
                  </div>
                </mat-cell>
              </ng-container>
              <mat-header-row *matHeaderRowDef="factorDisplayedColumns; sticky: true"></mat-header-row>
              <mat-row *matRowDef="let row; let rowIndex = dataIndex; columns: factorDisplayedColumns"></mat-row>
              <mat-row
                class="expandable-row"
                *matRowDef="let row; columns: ['expandedDetail']"
                [ngClass]="{
                  'row-is-locked':
                    (isFormLockedForEdit$ | async) &&
                    (factorsTableEditIndex$ | async) !== null &&
                    (factorsTableEditIndex$ | async) === rowIndex
                }"
              ></mat-row>
            </mat-table>
          </ng-container>
          <ng-container>
            <ng-template #initialFactorsMessage>
              <br />
              <div class="no-factor-message-container">
                <span
                  class="ft-14-600 no-factor-message"
                  [innerHTML]="'home.new-experiment.design.factors.inital.include-message' | translate"
                ></span>
              </div>
            </ng-template>
          </ng-container>
          <button
            type="button"
            class="ft-12-700 add-factor"
            *ngIf="!experimentInfo"
            [ngClass]="{
              'add-factor--disabled': (isFormLockedForEdit$ | async)
            }"
            [disabled]="isFormLockedForEdit$ | async"
            (click)="addFactor()"
          >
            +
            {{ 'home.new-experiment.design.add-experiment-factor.text' | translate }}
          </button>
          <button
            type="button"
            class="ft-12-700 add-factor"
            *ngIf="experimentInfo"
            [ngClass]="{
              'add-factor--disabled': !isExperimentEditable || (isFormLockedForEdit$ | async)
            }"
            [disabled]="!isExperimentEditable || (isFormLockedForEdit$ | async)"
            (click)="addFactor()"
          >
            +
            {{ 'home.new-experiment.design.add-experiment-factor.text' | translate }}
          </button>
          <div
            class="validation-container"
            *ngIf="
              factorPointErrors.length ||
              levelPointErrors.length ||
              factorCountError ||
              levelCountError ||
              conditionCountError
            "
          >
            <span class="ft-14-600 validation-message" *ngFor="let error of factorPointErrors">{{ error }}</span>
            <span class="ft-14-600 validation-message" *ngFor="let error of levelPointErrors">{{ error }}</span>
            <span class="ft-14-600 validation-message" *ngIf="factorCountError" [innerHTML]="factorCountError"></span>
            <span class="ft-14-600 validation-message" *ngIf="levelCountError" [innerHTML]="levelCountError"></span>
            <span
              class="ft-14-600 validation-message"
              *ngIf="conditionCountError"
              [innerHTML]="conditionCountError"
            ></span>
          </div>
          <br />
          <br />
          <div>
            <div *ngIf="this.factor.length >= 2">
              <br />
              <app-conditions-table
                [isAnyRowRemoved]="isAnyRowRemoved"
                [experimentInfo]="experimentInfo"
                [isExperimentEditable]="isExperimentEditable"
              ></app-conditions-table>
            </div>
          </div>
        </section>
      </form>
    </section>
  </section>

  <section class="shared-modal--buttons-container sticky">
    <span class="shared-modal--buttons-left">
      <button
        matStepperPrevious
        mat-raised-button
        class="shared-modal--modal-btn btn-back default-button"
        [class.default-button--disabled]="isFormLockedForEdit$ | async"
        [disabled]="isFormLockedForEdit$ | async"
        (click)="
          factorialExperimentDesignForm.dirty ? experimentDesignStepperService.experimentStepperDataChanged() : ''
        "
      >
        {{ 'global.back.text' | translate }}
      </button>
    </span>
    <span class="shared-modal--buttons-right">
      <button
        type="button"
        mat-raised-button
        class="shared-modal--modal-btn"
        (click)="emitEvent(NewExperimentDialogEvents.CLOSE_DIALOG)"
      >
        {{ 'global.cancel.text' | translate }}
      </button>
      <button
        type="button"
        mat-raised-button
        class="shared-modal--modal-btn default-button"
        (click)="emitEvent(NewExperimentDialogEvents.SEND_FORM_DATA)"
        [class.default-button--disabled]="isFormLockedForEdit$ | async"
        [disabled]="isFormLockedForEdit$ | async"
      >
        {{ 'global.next.text' | translate }}
      </button>
      <button
        type="button"
        *ngIf="experimentInfo"
        mat-raised-button
        class="shared-modal--modal-btn default-button"
        [ngClass]="{ 'default-button--disabled': (isFormLockedForEdit$ | async) || !isExperimentEditable }"
        [disabled]="(isFormLockedForEdit$ | async) || !isExperimentEditable"
        (click)="emitEvent(NewExperimentDialogEvents.SAVE_DATA)"
      >
        {{ 'global.save.text' | translate }}
      </button>
    </span>
  </section>
</div>
